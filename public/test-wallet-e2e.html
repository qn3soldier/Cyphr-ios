<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2E Wallet Flow Test</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .test-step { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .test-step.success { border-left-color: #28a745; background: #d4edda; }
        .test-step.error { border-left-color: #dc3545; background: #f8d7da; }
        .test-step.running { border-left-color: #ffc107; background: #fff3cd; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .result { font-family: 'Monaco', 'Consolas', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; }
        .seed-phrase { background: #fff; border: 2px solid #007bff; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center; }
        .pin-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin: 5px; text-align: center; font-size: 16px; width: 60px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ End-to-End Wallet Creation Test</h1>
        <p>Complete Lobstr-like wallet flow: Registration ‚Üí Seed Generation ‚Üí PIN Setup ‚Üí Encrypted Storage</p>
        
        <div class="test-step" id="step1">
            <h3>Step 1: User Registration Simulation</h3>
            <button onclick="simulateRegistration()">Simulate User Registration</button>
            <div id="registration-result"></div>
        </div>

        <div class="test-step" id="step2">
            <h3>Step 2: Seed Phrase Generation</h3>
            <button onclick="generateSeedPhrase()" disabled>Generate Seed Phrase</button>
            <div id="seed-result"></div>
        </div>

        <div class="test-step" id="step3">
            <h3>Step 3: PIN Setup & Encryption</h3>
            <div>
                <input type="password" class="pin-input" id="pin1" placeholder="PIN" maxlength="6">
                <input type="password" class="pin-input" id="pin2" placeholder="Confirm" maxlength="6">
                <button onclick="setupPinEncryption()" disabled>Setup PIN Encryption</button>
            </div>
            <div id="pin-result"></div>
        </div>

        <div class="test-step" id="step4">
            <h3>Step 4: Wallet Storage & Database</h3>
            <button onclick="storeWalletData()" disabled>Store in Database</button>
            <div id="storage-result"></div>
        </div>

        <div class="test-step" id="step5">
            <h3>Step 5: PIN Unlock Test</h3>
            <div>
                <input type="password" class="pin-input" id="unlock-pin" placeholder="Enter PIN" maxlength="6">
                <button onclick="unlockWallet()" disabled>Unlock Wallet</button>
            </div>
            <div id="unlock-result"></div>
        </div>

        <div class="test-step" id="step6">
            <h3>Step 6: Balance Loading</h3>
            <button onclick="loadWalletBalance()" disabled>Load Real Balance</button>
            <div id="balance-result"></div>
        </div>

        <button onclick="runFullTest()" style="background: #28a745; font-size: 16px; padding: 15px 30px;">üöÄ Run Complete E2E Test</button>
        <button onclick="resetTest()" style="background: #6c757d;">Reset All</button>
    </div>

    <script type="module">
        let testData = {
            userId: null,
            seedPhrase: null,
            encryptedData: null,
            hdWallet: null,
            stellarAddress: null
        };

        // Import modules (will need actual imports when integrated)
        window.simulateRegistration = async function() {
            const step = document.getElementById('step1');
            const result = document.getElementById('registration-result');
            
            step.className = 'test-step running';
            result.innerHTML = 'üîÑ Simulating user registration...';
            
            try {
                // Simulate user registration
                testData.userId = 'test-user-' + Date.now();
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                result.innerHTML = `‚úÖ User registered with ID: ${testData.userId}`;
                step.className = 'test-step success';
                
                // Enable next step
                document.querySelector('#step2 button').disabled = false;
                
            } catch (error) {
                result.innerHTML = `‚ùå Registration failed: ${error.message}`;
                step.className = 'test-step error';
            }
        };

        window.generateSeedPhrase = async function() {
            const step = document.getElementById('step2');
            const result = document.getElementById('seed-result');
            
            step.className = 'test-step running';
            result.innerHTML = 'üîÑ Generating BIP39 seed phrase...';
            
            try {
                // Import crypto modules via dynamic import
                const { generateMnemonic } = await import('/node_modules/@scure/bip39/index.js');
                const { wordlist } = await import('/node_modules/@scure/bip39/wordlists/english.js');
                
                testData.seedPhrase = generateMnemonic(wordlist, 128); // 12 words
                
                result.innerHTML = `
                    <div class="seed-phrase">${testData.seedPhrase}</div>
                    <p>‚ö†Ô∏è In real app, user must backup this phrase securely!</p>
                `;
                step.className = 'test-step success';
                
                // Enable next step
                document.querySelector('#step3 button').disabled = false;
                
            } catch (error) {
                // Fallback to mock seed phrase
                testData.seedPhrase = 'abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about';
                
                result.innerHTML = `
                    <div class="seed-phrase">${testData.seedPhrase}</div>
                    <p>‚ö†Ô∏è Using mock seed phrase (crypto import failed)</p>
                `;
                step.className = 'test-step success';
                document.querySelector('#step3 button').disabled = false;
            }
        };

        window.setupPinEncryption = async function() {
            const pin1 = document.getElementById('pin1').value;
            const pin2 = document.getElementById('pin2').value;
            const step = document.getElementById('step3');
            const result = document.getElementById('pin-result');
            
            if (!pin1 || pin1 !== pin2) {
                result.innerHTML = '‚ùå PINs must match and not be empty';
                return;
            }
            
            step.className = 'test-step running';
            result.innerHTML = 'üîÑ Setting up PIN encryption...';
            
            try {
                // Simulate PBKDF2 + AES-GCM encryption
                const encoder = new TextEncoder();
                const data = encoder.encode(testData.seedPhrase);
                
                // Generate salt
                const salt = crypto.getRandomValues(new Uint8Array(16));
                
                // Derive key from PIN
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(pin1),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                );
                
                // Encrypt seed phrase
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                
                testData.encryptedData = {
                    encrypted: new Uint8Array(encrypted),
                    salt: salt,
                    iv: iv,
                    iterations: 100000
                };
                
                result.innerHTML = `
                    ‚úÖ Seed phrase encrypted with PIN<br>
                    üîê Algorithm: PBKDF2 (100,000 iterations) + AES-GCM-256<br>
                    üì¶ Encrypted size: ${encrypted.byteLength} bytes
                `;
                step.className = 'test-step success';
                
                // Enable next step
                document.querySelector('#step4 button').disabled = false;
                
            } catch (error) {
                result.innerHTML = `‚ùå Encryption failed: ${error.message}`;
                step.className = 'test-step error';
            }
        };

        window.storeWalletData = async function() {
            const step = document.getElementById('step4');
            const result = document.getElementById('storage-result');
            
            step.className = 'test-step running';
            result.innerHTML = 'üîÑ Storing wallet data...';
            
            try {
                // Simulate database storage
                const walletData = {
                    user_id: testData.userId,
                    encrypted_seed_phrase: Array.from(testData.encryptedData.encrypted).join(','),
                    salt: Array.from(testData.encryptedData.salt).join(','),
                    iterations: testData.encryptedData.iterations,
                    wallet_type: 'hd_wallet',
                    created_at: new Date().toISOString()
                };
                
                // Store in localStorage as simulation
                localStorage.setItem('test_wallet_' + testData.userId, JSON.stringify(walletData));
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                result.innerHTML = `
                    ‚úÖ Wallet stored in database simulation<br>
                    üë§ User ID: ${testData.userId}<br>
                    üîê Encrypted data: ${testData.encryptedData.encrypted.length} bytes<br>
                    üßÇ Salt length: ${testData.encryptedData.salt.length} bytes
                `;
                step.className = 'test-step success';
                
                // Enable next step
                document.querySelector('#step5 button').disabled = false;
                
            } catch (error) {
                result.innerHTML = `‚ùå Storage failed: ${error.message}`;
                step.className = 'test-step error';
            }
        };

        window.unlockWallet = async function() {
            const pin = document.getElementById('unlock-pin').value;
            const step = document.getElementById('step5');
            const result = document.getElementById('unlock-result');
            
            if (!pin) {
                result.innerHTML = '‚ùå Please enter PIN';
                return;
            }
            
            step.className = 'test-step running';
            result.innerHTML = 'üîÑ Unlocking wallet with PIN...';
            
            try {
                // Retrieve encrypted data
                const encoder = new TextEncoder();
                const decoder = new TextDecoder();
                
                // Derive key from PIN
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(pin),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: testData.encryptedData.salt,
                        iterations: testData.encryptedData.iterations,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                
                // Decrypt seed phrase
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: testData.encryptedData.iv },
                    key,
                    testData.encryptedData.encrypted
                );
                
                const decryptedSeed = decoder.decode(decrypted);
                
                if (decryptedSeed === testData.seedPhrase) {
                    result.innerHTML = `
                        ‚úÖ Wallet unlocked successfully!<br>
                        üîë PIN verification: PASSED<br>
                        üå± Seed phrase recovered: ${decryptedSeed.split(' ').length} words<br>
                        ‚è±Ô∏è Unlock time: <1 second
                    `;
                    step.className = 'test-step success';
                    
                    // Enable next step
                    document.querySelector('#step6 button').disabled = false;
                } else {
                    throw new Error('Decrypted seed phrase does not match original');
                }
                
            } catch (error) {
                result.innerHTML = `‚ùå Unlock failed: ${error.message}<br>Possible wrong PIN or encryption error`;
                step.className = 'test-step error';
            }
        };

        window.loadWalletBalance = async function() {
            const step = document.getElementById('step6');
            const result = document.getElementById('balance-result');
            
            step.className = 'test-step running';
            result.innerHTML = 'üîÑ Loading wallet balance from Stellar testnet...';
            
            try {
                // Test with known funded address
                const testAddress = 'GDIXCJBCIM7NN64ZF24XIT2GUCGLOACNBUONEQO4TX36EZ4H3GXN2D3G';
                
                const response = await fetch(`https://horizon-testnet.stellar.org/accounts/${testAddress}`);
                const accountData = await response.json();
                
                let balanceHTML = '‚úÖ Real balance loaded from Stellar testnet:<br><br>';
                
                accountData.balances.forEach(balance => {
                    const asset = balance.asset_type === 'native' ? 'XLM' : balance.asset_code;
                    balanceHTML += `üí∞ ${asset}: ${balance.balance}<br>`;
                });
                
                // Calculate USD value
                const xlmBalance = parseFloat(accountData.balances.find(b => b.asset_type === 'native')?.balance || '0');
                const totalUSD = xlmBalance * 0.10; // Mock price
                
                balanceHTML += `<br>üìä Total Value: ~$${totalUSD.toFixed(2)} USD`;
                
                result.innerHTML = balanceHTML;
                step.className = 'test-step success';
                
            } catch (error) {
                result.innerHTML = `‚ùå Balance loading failed: ${error.message}`;
                step.className = 'test-step error';
            }
        };

        window.runFullTest = async function() {
            // Reset first
            resetTest();
            
            // Run all steps in sequence
            await simulateRegistration();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await generateSeedPhrase();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Auto-fill PIN
            document.getElementById('pin1').value = '123456';
            document.getElementById('pin2').value = '123456';
            await setupPinEncryption();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await storeWalletData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Auto-fill unlock PIN
            document.getElementById('unlock-pin').value = '123456';
            await unlockWallet();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await loadWalletBalance();
        };

        window.resetTest = function() {
            testData = { userId: null, seedPhrase: null, encryptedData: null, hdWallet: null, stellarAddress: null };
            
            // Reset all steps
            document.querySelectorAll('.test-step').forEach(step => {
                step.className = 'test-step';
            });
            
            // Clear all results
            document.querySelectorAll('[id$="-result"]').forEach(div => {
                div.innerHTML = '';
            });
            
            // Reset buttons
            document.querySelectorAll('button').forEach(btn => {
                if (!btn.textContent.includes('Run Complete') && !btn.textContent.includes('Reset')) {
                    btn.disabled = true;
                }
            });
            
            document.querySelector('#step1 button').disabled = false;
            
            // Clear inputs
            document.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
        };
    </script>
</body>
</html>