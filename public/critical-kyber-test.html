<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê CRITICAL Kyber1024 Test - Polynomial Operations Verification</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #000; 
            color: #0f0; 
            padding: 20px; 
            line-height: 1.6;
        }
        .header { color: #ff0; font-size: 1.2em; margin-bottom: 20px; }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            border-left: 4px solid #0f0; 
            background: #001100;
        }
        .error { border-left-color: #f00; color: #f00; background: #110000; }
        .success { border-left-color: #0f0; color: #0f0; background: #001100; }
        .info { border-left-color: #00f; color: #00f; background: #000011; }
        .warning { border-left-color: #ff0; color: #ff0; background: #111100; }
        .critical { border-left-color: #f0f; color: #f0f; background: #110011; font-weight: bold; }
        button { 
            background: #333; 
            color: #0f0; 
            border: 1px solid #0f0; 
            padding: 15px 30px; 
            margin: 10px; 
            cursor: pointer; 
            font-size: 16px;
            font-family: inherit;
        }
        button:hover { background: #0f0; color: #000; }
        .test-code {
            background: #222;
            color: #fff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">üîê CRITICAL KYBER1024 POST-QUANTUM CRYPTOGRAPHY TEST</div>
    <div class="header">Testing Polynomial Operations in Ring Z_q[X]/(X^256 + 1)</div>
    
    <p class="info">This test verifies if the Kyber1024 implementation correctly handles polynomial arithmetic operations as reported by the user.</p>
    
    <button onclick="runCriticalTest()">üöÄ RUN CRITICAL TEST</button>
    <button onclick="runExtensiveTest()">üß™ RUN EXTENSIVE TEST (100 iterations)</button>
    <button onclick="clearResults()">üóëÔ∏è CLEAR RESULTS</button>
    
    <div id="results"></div>

    <script type="module">
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Auto-scroll to bottom
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            console.clear();
        }

        async function runCriticalTest() {
            clearResults();
            log('üîê CRITICAL KYBER1024 POLYNOMIAL OPERATION TEST STARTING...', 'critical');
            log('Testing for the issue: "treating ring arithmetic as simple array manipulations"', 'warning');
            log('Expected: Proper polynomial operations in Z_q[X]/(X^256 + 1)', 'info');
            
            try {
                // Test 1: Import verification
                log('1Ô∏è‚É£ Testing pqc-kyber library import...', 'info');
                const { keypair, encapsulate, decapsulate, Params } = await import('/node_modules/pqc-kyber/pqc_kyber.js');
                log('‚úÖ pqc-kyber library imported successfully', 'success');
                
                // Test 2: Parameter verification
                log('2Ô∏è‚É£ Verifying Kyber1024 parameters...', 'info');
                log(`   Public key size: ${Params.publicKeyBytes} bytes`, 'info');
                log(`   Secret key size: ${Params.secretKeyBytes} bytes`, 'info');
                log(`   Ciphertext size: ${Params.ciphertextBytes} bytes`, 'info');
                log(`   Shared secret size: ${Params.sharedSecretBytes} bytes`, 'info');
                
                if (Params.publicKeyBytes !== 1568 || Params.secretKeyBytes !== 3168 || 
                    Params.ciphertextBytes !== 1568 || Params.sharedSecretBytes !== 32) {
                    log('‚ö†Ô∏è  WARNING: Parameter sizes do not match expected Kyber1024 values', 'warning');
                    log('   Expected: pub=1568, sec=3168, ct=1568, ss=32', 'warning');
                }
                
                // Test 3: Critical polynomial operation test
                log('3Ô∏è‚É£ CRITICAL TEST: Polynomial operation correctness...', 'critical');
                
                let totalTests = 10;
                let passedTests = 0;
                let failedTests = 0;
                const performanceTimes = [];
                
                for (let i = 0; i < totalTests; i++) {
                    const testStart = performance.now();
                    
                    try {
                        // Generate key pair
                        const keys = keypair();
                        
                        if (!keys || !keys.pubkey || !keys.secret) {
                            throw new Error(`Key generation failed in iteration ${i + 1}`);
                        }
                        
                        // Encapsulate
                        const encaps = encapsulate(keys.pubkey);
                        
                        if (!encaps || !encaps.ciphertext || !encaps.sharedSecret) {
                            throw new Error(`Encapsulation failed in iteration ${i + 1}`);
                        }
                        
                        // Decapsulate
                        const decaps = decapsulate(encaps.ciphertext, keys.secret);
                        
                        if (!decaps) {
                            throw new Error(`Decapsulation failed in iteration ${i + 1}`);
                        }
                        
                        // CRITICAL TEST: Verify shared secrets match
                        // If polynomial operations were incorrect, this would fail intermittently
                        const secretsMatch = encaps.sharedSecret.length === decaps.length &&
                            encaps.sharedSecret.every((byte, idx) => byte === decaps[idx]);
                        
                        const testTime = performance.now() - testStart;
                        performanceTimes.push(testTime);
                        
                        if (secretsMatch) {
                            passedTests++;
                            log(`   ‚úÖ Test ${i + 1}/${totalTests}: PASSED (${testTime.toFixed(2)}ms)`, 'success');
                        } else {
                            failedTests++;
                            log(`   ‚ùå Test ${i + 1}/${totalTests}: FAILED - Shared secrets don't match!`, 'error');
                            log(`      This indicates polynomial operations are INCORRECT!`, 'error');
                            log(`      Original: ${Array.from(encaps.sharedSecret.slice(0, 8)).map(b => b.toString(16).padStart(2, '0')).join(' ')}...`, 'error');
                            log(`      Decaps:   ${Array.from(decaps.slice(0, 8)).map(b => b.toString(16).padStart(2, '0')).join(' ')}...`, 'error');
                        }
                        
                    } catch (error) {
                        failedTests++;
                        log(`   ‚ùå Test ${i + 1}/${totalTests}: ERROR - ${error.message}`, 'error');
                    }
                }
                
                // Test 4: Results analysis
                log('4Ô∏è‚É£ CRITICAL ANALYSIS OF POLYNOMIAL OPERATIONS...', 'critical');
                
                const avgTime = performanceTimes.reduce((a, b) => a + b, 0) / performanceTimes.length;
                const successRate = (passedTests / totalTests) * 100;
                
                log(`   Total tests: ${totalTests}`, 'info');
                log(`   Passed: ${passedTests}`, passedTests === totalTests ? 'success' : 'error');
                log(`   Failed: ${failedTests}`, failedTests === 0 ? 'success' : 'error');
                log(`   Success rate: ${successRate.toFixed(1)}%`, successRate === 100 ? 'success' : 'error');
                log(`   Average time: ${avgTime.toFixed(2)}ms`, avgTime < 10 ? 'success' : 'warning');
                
                // Final verdict
                log('üéØ FINAL VERDICT ON POLYNOMIAL OPERATIONS:', 'critical');
                
                if (successRate === 100) {
                    log('üéâüéâüéâ POLYNOMIAL OPERATIONS ARE CORRECT! üéâüéâüéâ', 'success');
                    log('‚úÖ Ring arithmetic Z_q[X]/(X^256 + 1) is properly implemented', 'success');
                    log('‚úÖ No evidence of "simple array manipulations" instead of polynomial ops', 'success');
                    log('‚úÖ Kyber1024 is mathematically sound and ready for production', 'success');
                    log('‚úÖ Post-quantum cryptography is WORKING CORRECTLY', 'success');
                } else if (successRate >= 90) {
                    log('‚ö†Ô∏è  MARGINAL: Some polynomial operations failed', 'warning');
                    log('   This could indicate intermittent issues with the implementation', 'warning');
                    log('   Recommend further investigation and testing', 'warning');
                } else {
                    log('‚ùå‚ùå‚ùå CRITICAL FAILURE: POLYNOMIAL OPERATIONS ARE BROKEN! ‚ùå‚ùå‚ùå', 'error');
                    log('‚ùå Ring arithmetic is NOT properly implemented', 'error');
                    log('‚ùå Confirms user report: treating ring arithmetic as array operations', 'error');
                    log('‚ùå Kyber1024 is MATHEMATICALLY UNSOUND - DO NOT USE IN PRODUCTION', 'error');
                    log('‚ùå Post-quantum security is COMPROMISED', 'error');
                }
                
                // Performance analysis
                if (avgTime > 20) {
                    log('‚ö†Ô∏è  Performance note: Average time exceeds 20ms target', 'warning');
                } else {
                    log('‚úÖ Performance: Within acceptable limits', 'success');
                }
                
            } catch (error) {
                log('‚ùå‚ùå‚ùå CRITICAL TEST FAILED ‚ùå‚ùå‚ùå', 'error');
                log(`Error: ${error.message}`, 'error');
                
                if (error.message.includes('import')) {
                    log('üîß Import error detected. Solutions:', 'warning');
                    log('   1. Ensure you are accessing this page from http://localhost:5173/', 'warning');
                    log('   2. Verify pqc-kyber package is installed', 'warning');
                    log('   3. Check that WASM file is accessible', 'warning');
                }
            }
        }

        async function runExtensiveTest() {
            log('üß™ EXTENSIVE POLYNOMIAL OPERATION TEST (100 iterations)...', 'info');
            log('This will take longer but provides more confidence in the results', 'info');
            
            try {
                const { keypair, encapsulate, decapsulate, Params } = await import('/node_modules/pqc-kyber/pqc_kyber.js');
                
                let totalTests = 100;
                let passedTests = 0;
                let failedTests = 0;
                const times = [];
                
                for (let i = 0; i < totalTests; i++) {
                    const start = performance.now();
                    
                    try {
                        const keys = keypair();
                        const encaps = encapsulate(keys.pubkey);
                        const decaps = decapsulate(encaps.ciphertext, keys.secret);
                        
                        const match = encaps.sharedSecret.every((b, idx) => b === decaps[idx]);
                        const time = performance.now() - start;
                        times.push(time);
                        
                        if (match) {
                            passedTests++;
                            if (i % 10 === 9) {
                                log(`   Progress: ${i + 1}/${totalTests} tests completed`, 'info');
                            }
                        } else {
                            failedTests++;
                            log(`   ‚ùå Test ${i + 1} FAILED`, 'error');
                        }
                        
                    } catch (error) {
                        failedTests++;
                        log(`   ‚ùå Test ${i + 1} ERROR: ${error.message}`, 'error');
                    }
                }
                
                const successRate = (passedTests / totalTests) * 100;
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const minTime = Math.min(...times);
                const maxTime = Math.max(...times);
                
                log('üìä EXTENSIVE TEST RESULTS:', 'critical');
                log(`   Tests completed: ${totalTests}`, 'info');
                log(`   Successful: ${passedTests}`, 'info');
                log(`   Failed: ${failedTests}`, 'info');
                log(`   Success rate: ${successRate.toFixed(2)}%`, successRate === 100 ? 'success' : 'error');
                log(`   Average time: ${avgTime.toFixed(2)}ms`, 'info');
                log(`   Min time: ${minTime.toFixed(2)}ms`, 'info');
                log(`   Max time: ${maxTime.toFixed(2)}ms`, 'info');
                
                if (successRate === 100) {
                    log('üéâ EXTENSIVE TEST CONFIRMS: Polynomial operations are CORRECT!', 'success');
                } else {
                    log('‚ùå EXTENSIVE TEST CONFIRMS: Polynomial operations have ISSUES!', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Extensive test failed: ${error.message}`, 'error');
            }
        }

        // Make functions global
        window.runCriticalTest = runCriticalTest;
        window.runExtensiveTest = runExtensiveTest;
        window.clearResults = clearResults;

        // Auto-start critical test after page load
        document.addEventListener('DOMContentLoaded', () => {
            log('üîê Critical Kyber1024 Test Suite Loaded', 'success');
            log('Click "RUN CRITICAL TEST" to verify polynomial operations', 'info');
            log('This test specifically checks for the reported issue:', 'warning');
            log('"treating ring arithmetic as simple array manipulations"', 'warning');
            
            // Auto-run after 2 seconds
            setTimeout(() => {
                log('üöÄ Auto-starting critical test in 3 seconds...', 'info');
                setTimeout(runCriticalTest, 3000);
            }, 2000);
        });
    </script>
</body>
</html>