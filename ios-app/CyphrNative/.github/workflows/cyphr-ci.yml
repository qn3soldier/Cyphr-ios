name: Cyphr CI (iOS + ZK guard)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IOS_PROJECT: ios-app/CyphrNative/CyphrNative.xcodeproj
  IOS_SCHEME: CyphrNative
  IOS_DESTINATION: 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5'
  IOS_WORKDIR: ios-app/CyphrNative
  SERVER_DIR: server

jobs:
  # --- ZK guard Ð´Ð»Ñ ÑÐµÑ€Ð²ÐµÑ€Ð° (Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð¸ Ð´ÐµÑˆÑ‘Ð²Ñ‹Ð¹) ---
  zk-guard-server:
    name: "ZK Guard (server: forbid decrypt)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate server directory exists (optional)
        run: |
          if [ ! -d "$SERVER_DIR" ]; then
            echo "::warning::No $SERVER_DIR directory detected; skipping server ZK guard."
            exit 0
          fi

      - name: Forbid decrypt / PQC libs on server
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ”Ž Running forbid-server-decryptâ€¦"
          bash .github/scripts/forbid_server_decrypt.sh "$SERVER_DIR"

  # --- Ð¡ÐºÐ°Ð½ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð² PR) ---
  secrets-scan:
    name: "Secrets scan (gitleaks)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --redact
    # ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¸Ð· Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸/Ð´Ð¾ÐºÐ¾Ð² Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð¾Ñ‚Ð°Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð¸ Ð²Ñ‹Ð½ÐµÑÐµÐ½Ñ‹ Ð² env/Secrets Manager

  # --- iOS build + unit tests + Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð³ÐµÐ¹Ñ‚Ñ‹ Ð¿Ð¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ð¼ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼ ---
  ios-build-test:
    name: "iOS build & tests + critical gates"
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Xcode version
        run: xcodebuild -version

      - name: Resolve SPM
        working-directory: ${{ env.IOS_WORKDIR }}
        run: |
          xcodebuild -resolvePackageDependencies -project "${IOS_PROJECT}"

      - name: Build & Test (Simulator)
        working-directory: ${{ env.IOS_WORKDIR }}
        run: |
          set -euo pipefail
          xcodebuild \
            -project "${IOS_PROJECT}" \
            -scheme "${IOS_SCHEME}" \
            -destination "${IOS_DESTINATION}" \
            -configuration Debug \
            -enableCodeCoverage YES \
            clean test

      # --- Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð³ÐµÐ¹Ñ‚Ñ‹ Ð½Ð° Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ðµ Ð±Ð»Ð¾ÐºÐµÑ€Ñ‹ ---
      - name: "Gate: BIP39 wordlist must be in Xcode Copy Bundle Resources"
        run: |
          set -euo pipefail
          PROJ="${{ env.IOS_PROJECT }}"
          if ! grep -R "bip39-english.txt" "$PROJ/project.pbxproj" >/dev/null; then
            echo "::error::bip39-english.txt is not referenced in Xcode project (Copy Bundle Resources)."
            exit 1
          fi
        # ÑÐ¼. Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð±Ð°Ð³Ð¸ Ð¿Ð¾ BIP39 Ð² ÑÑ‚Ð°Ñ‚ÑƒÑÐµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°/roadmap

      - name: "Gate: Info.plist must declare NSFaceIDUsageDescription"
        run: |
          set -euo pipefail
          INFOPLIST=$(git ls-files | grep -E "/Info\.plist$" | head -n1 || true)
          if [ -z "$INFOPLIST" ]; then
            echo "::warning::No Info.plist found via quick scan â€” adjust path or add explicit check."
          else
            if ! /usr/libexec/PlistBuddy -c "Print :NSFaceIDUsageDescription" "$INFOPLIST" >/dev/null 2>&1; then
              echo "::error::NSFaceIDUsageDescription key missing in $INFOPLIST"
              exit 1
            fi
          fi

      - name: "Gate: iOS deployment target >= 15.0 (no phantom SDKs)"
        run: |
          set -euo pipefail
          PROJ="${{ env.IOS_PROJECT }}"
          if ! grep -E "IPHONEOS_DEPLOYMENT_TARGET = (1[5-9]|[2-9][0-9])" "$PROJ/project.pbxproj" >/dev/null; then
            echo "::error::Minimum iOS target must be >= 15.0"
            exit 1
          fi

      - name: "Gate: LoadingOverlay usage present in app code (advisory)"
        continue-on-error: true
        run: |
          if ! grep -R "\.loadingOverlay\(" "${{ env.IOS_WORKDIR }}" -n --include="*.swift" >/dev/null; then
            echo "::warning::No LoadingOverlay usage detected â€” ensure async flows show progress."
          fi

  # --- Backend sanity (optional: lint/tests) ---
  backend-node:
    name: "Backend sanity (install + optional tests)"
    runs-on: ubuntu-latest
    if: ${{ hashFiles(format('{0}/package.json', env.SERVER_DIR)) != '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install
        working-directory: ${{ env.SERVER_DIR }}
        run: npm ci
      - name: Lint (optional)
        if: hashFiles(format('{0}/.eslintrc*', env.SERVER_DIR)) != ''
        working-directory: ${{ env.SERVER_DIR }}
        run: npm run lint --if-present
      - name: Tests (optional)
        working-directory: ${{ env.SERVER_DIR }}
        run: npm test --if-present